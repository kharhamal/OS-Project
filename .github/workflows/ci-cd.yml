name: FastAPI CI/CD Pipeline

# Ø§Ø¬Ø±Ø§ Ø´Ø¯Ù† ÙÙ‚Ø· Ø±ÙˆÛŒ Ø´Ø§Ø®Ù‡ main
on:
  push:
    branches: [ "main" ]

jobs:
  # ------------------------------------
  # ğŸ”¹ Ø¨Ø®Ø´ Ø¯ÙˆÙ…: Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ (CI)
  # ------------------------------------
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        run: |
          pytest

  # ------------------------------------
  # ğŸ”¹ Ø¨Ø®Ø´ Ø³ÙˆÙ…: Ø³Ø§Ø®Øª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒØ¬ (Docker Integration)
  # ------------------------------------
  build-and-push:
    needs: test  # ÙÙ‚Ø· Ø§Ú¯Ø± ØªØ³Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ø³ Ø´Ø¯Ù†Ø¯ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/fastapi-project:latest

  # ------------------------------------
  # ğŸ”¹ Ø¨Ø®Ø´ Ú†Ù‡Ø§Ø±Ù…: Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± (CD)
  # ------------------------------------
  deploy:
    needs: build-and-push  # ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø² Ø¨ÛŒÙ„Ø¯ Ù…ÙˆÙÙ‚ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø§ÛŒÙ…ÛŒØ¬
            docker pull ${{ secrets.DOCKER_USERNAME }}/fastapi-project:latest
            
            # ØªÙˆÙ‚Ù Ùˆ Ø­Ø°Ù Ú©Ø§Ù†ØªÛŒÙ†Ø± Ù‚Ø¨Ù„ÛŒ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
            docker stop fastapi-container || true
            docker rm fastapi-container || true
            
            # Ø§Ø¬Ø±Ø§ÛŒ Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø¬Ø¯ÛŒØ¯ Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 80
            docker run -d --name fastapi-container -p 80:80 ${{ secrets.DOCKER_USERNAME }}/fastapi-project:latest